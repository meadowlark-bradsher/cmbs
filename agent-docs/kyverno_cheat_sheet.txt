Kyverno Policy Cheat Sheet

ClusterPolicy — Cluster-wide Kubernetes policies

A ClusterPolicy is a Kyverno policy that applies to the entire cluster.

Required structure:

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: policy-name
spec:
  validationFailureAction: Audit
  rules:
    - name: rule-name
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: "Violation message"
        pattern:
          spec:
            fieldName: expectedValue

CRITICAL: metadata.name is REQUIRED. A policy without a name will fail to apply.


Match — Selecting which resources to validate

The match block specifies which Kubernetes resources the rule applies to.

Example matching Pods:
match:
  any:
    - resources:
        kinds:
          - Pod

Example matching Pods in a specific namespace:
match:
  any:
    - resources:
        kinds:
          - Pod
        namespaces:
          - production


Validate — Checking resource patterns

The validate block specifies what the resource should look like.

To check that a field equals a value:
validate:
  pattern:
    spec:
      hostNetwork: false

To check that a field is NOT equal to a value, use "!" prefix:
validate:
  pattern:
    spec:
      hostNetwork: "!true"

The "!" prefix means "not equal to".


HostNetwork — Block pods sharing host network

Example policy to detect pods using hostNetwork=true:

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-host-network
spec:
  validationFailureAction: Audit
  rules:
    - name: deny-host-network
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: "Pods cannot use hostNetwork=true"
        pattern:
          spec:
            hostNetwork: "!true"


ValidationFailureAction — Audit vs Enforce

validationFailureAction controls what happens when a resource violates the policy:

- Audit: Log the violation but allow the resource (for monitoring existing pods)
- Enforce: Block the resource from being created

For checking existing pods, use Audit. Enforce only affects new pods.


PolicyReport — Checking for violations

Kyverno creates PolicyReport resources to track violations.

Check for violations:
kubectl get policyreport -A -o yaml

The report shows:
- pass: resources that comply
- fail: resources that violate the policy

Look at the "results" field for details on each pod.


CommonErrors — Fixing policy issues

1. Missing metadata.name:
   Error: "Name is required" or "error retrieving current configuration"
   Fix: Add metadata.name to the policy

2. Invalid apiVersion:
   Error: "no matches for kind"
   Fix: Use apiVersion: kyverno.io/v1

3. Missing rule name:
   Error: "spec.rules[0].name in body is required"
   Fix: Add name field to each rule in spec.rules

4. YAML syntax error:
   Error: "mapping values are not allowed" or "error converting YAML"
   Fix: Check indentation, use 2 spaces, ensure proper structure


Debugging — Troubleshooting policies

Debug Kyverno issues:

1. Validate policy syntax before applying:
   kubectl apply --dry-run=client -f policy.yaml

2. Check Kyverno controller logs:
   kubectl logs -n kyverno deployment/kyverno-admission-controller

3. Check if policy was created:
   kubectl get clusterpolicy

4. Check policy reports for violations:
   kubectl get policyreport -A -o yaml

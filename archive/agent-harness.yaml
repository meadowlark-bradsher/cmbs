# CMBS Agent Harness Configuration for ITBench
#
# This file configures how ITBench runs the CMBS agent.
# The agent harness reads scenario data and uploads agent output.

# Path where ITBench writes scenario data (goal, kubeconfig, etc.)
path_to_data_provided_by_scenario: /tmp/agent/scenario_data.json

# Path where agent output is collected for evaluation
path_to_data_pushed_to_scenario: /tmp/agent/agent_data.tar

# Command executed by the agent harness
run:
  command: ["/bin/bash"]
  args:
  - -c
  - |
    set -e

    timestamp=$(date +%Y%m%d%H%M%S)
    workdir=/tmp/agent/${timestamp}
    mkdir -p ${workdir}

    echo "[CMBS] Starting CMBS ITBench adapter"
    echo "[CMBS] Timestamp: ${timestamp}"
    echo "[CMBS] Workdir: ${workdir}"

    # Copy scenario data to workdir for reference
    cp /tmp/agent/scenario_data.json ${workdir}/scenario_data.json

    # Run the CMBS agent with timeout
    # The agent reads scenario_data.json and outputs artifacts to /tmp/agent
    cd /etc/cmbs
    timeout 200 python -m cmbs.itbench_harness \
        --scenario-data /tmp/agent/scenario_data.json \
        --output-dir /tmp/agent \
        --model qwen2.5:7b \
        --max-steps 30 \
        --timeout 180 \
        --result-file ${workdir}/agent-result.json \
        -v || true

    # Copy result back to main agent dir
    cp ${workdir}/agent-result.json /tmp/agent/agent-result.json 2>/dev/null || true

    # Archive all output for ITBench
    echo "[CMBS] Archiving agent output"
    tar -C /tmp/agent -cf /tmp/agent/agent_data.tar \
        --exclude='scenario_data.json' \
        --exclude='agent_data.tar' \
        . 2>/dev/null || tar -C /tmp/agent -cf /tmp/agent/agent_data.tar .

    echo "[CMBS] Agent run complete"
